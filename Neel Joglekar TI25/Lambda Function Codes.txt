//Lambda Function getEvents Code


// --- Using AWS SDK v3 with CommonJS syntax ---
const { DynamoDBClient, ScanCommand } = require("@aws-sdk/client-dynamodb");

// create DynamoDB client
const client = new DynamoDBClient({ region: "us-east-1" }); // change region if needed

exports.handler = async (event) => {
  try {
    console.log("Fetching events from DynamoDB...");

    // Scan the table
    const command = new ScanCommand({ TableName: "Events" });
    const response = await client.send(command);

    // Convert DynamoDB item structure to normal JSON
    const events = response.Items.map((item) => ({
      event_id: item.event_id.S,
      event_name: item.event_name.S,
      date: item.date.S,
      available_seats: Number(item.available_seats.N),
    }));

    // Generate HTML table for display
    const html = `
      <html>
        <head>
          <title>Available Events</title>
          <style>
            body { font-family: Arial; background: #f4f4f4; padding: 20px; }
            table { width: 100%; border-collapse: collapse; background: white; }
            th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
            th { background-color: #007bff; color: white; }
            tr:hover { background-color: #f1f1f1; }
          </style>
        </head>
        <body>
          <h2>Available Events</h2>
          <table>
            <tr><th>Event ID</th><th>Event Name</th><th>Date</th><th>Available Seats</th></tr>
            ${events.map(e => `
              <tr>
                <td>${e.event_id}</td>
                <td>${e.event_name}</td>
                <td>${e.date}</td>
                <td>${e.available_seats}</td>
              </tr>`).join('')}
          </table>
        </body>
      </html>
    `;

    // Return HTML to browser
    return {
      statusCode: 200,
      headers: {
        "Content-Type": "text/html",
        "Access-Control-Allow-Origin": "*"
      },
      body: html
    };

  } catch (error) {
    console.error("Error fetching events:", error);
    return {
      statusCode: 500,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: "Internal Server Error", error: error.message })
    };
  }
};



//Lambda Function bookEvent Code

const { DynamoDBClient, UpdateItemCommand } = require("@aws-sdk/client-dynamodb");

const ddbClient = new DynamoDBClient({ region: "us-east-1" });
const tableName = "Events"; // your DynamoDB table name

exports.handler = async (event) => {
  try {
    const body = JSON.parse(event.body);
    const eventId = body.event_id;
    const user = body.name;

    const params = {
      TableName: tableName,
      Key: { event_id: { S: eventId } },
      UpdateExpression: "SET available_seats = available_seats - :one",
      ConditionExpression: "available_seats > :zero",
      ExpressionAttributeValues: {
        ":one": { N: "1" },
        ":zero": { N: "0" }
      },
      ReturnValues: "UPDATED_NEW"
    };

    const result = await ddbClient.send(new UpdateItemCommand(params));

    return {
      statusCode: 200,
      body: JSON.stringify({
        message: `Seat successfully booked by ${user}`,
        remainingSeats: result.Attributes.available_seats.N
      })
    };
  } catch (err) {
    if (err.name === "ConditionalCheckFailedException") {
      return {
        statusCode: 400,
        body: JSON.stringify({ message: "Seat already booked by another user" })
      };
    }
    console.error("Error:", err);
    return {
      statusCode: 500,
      body: JSON.stringify({ message: "Internal Server Error", error: err.message })
    };
  }
};
